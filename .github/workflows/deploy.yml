name: Deploy to GCP VM

on:
  push:
    branches:
      - main
      - pipelines/data_scraping_pipepline
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Production VM
    runs-on: ubuntu-latest
    environment: production  # Add this line to use environment secrets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts
      
      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} \
            "echo 'SSH connection successful'"
      
      - name: Deploy to VM
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} << 'ENDSSH'
          
          # Navigate to project directory
          cd ~/RAG
          
          # Pull latest changes
          echo "üì• Pulling latest changes from GitHub..."
          git fetch origin
          git reset --hard origin/${{ github.ref_name }}
          
          # Show current commit
          echo "üìå Current commit: $(git log -1 --oneline)"
          
          # Stop containers
          echo "üõë Stopping containers..."
          docker compose -f docker-compose.prod.yml down
          
          # Rebuild containers
          echo "üî® Rebuilding containers..."
          docker compose -f docker-compose.prod.yml build --no-cache
          
          # Start containers
          echo "üöÄ Starting containers..."
          docker compose -f docker-compose.prod.yml up -d
          
          # Wait for containers to start
          echo "‚è≥ Waiting for containers to start..."
          sleep 15
          
          # Check container status
          echo "üìä Container status:"
          docker ps
          
          # Check logs
          echo "üìù Recent logs:"
          docker logs resume-api --tail=20
          
          ENDSSH
      
      - name: Health Check
        run: |
          echo "üè• Running health checks..."
          
          # Check FastAPI health
          echo "Checking FastAPI..."
          curl -f http://${{ secrets.VM_HOST }}:8000/health || exit 1
          
          # Check Qdrant health
          echo "Checking Qdrant..."
          curl -f http://${{ secrets.VM_HOST }}:6333/health || exit 1
          
          echo "‚úÖ All health checks passed!"
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **VM Host:** ${{ secrets.VM_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [API Health](http://${{ secrets.VM_HOST }}:8000/health)" >> $GITHUB_STEP_SUMMARY
          echo "- [API Docs](http://${{ secrets.VM_HOST }}:8000/docs)" >> $GITHUB_STEP_SUMMARY
          echo "- [Qdrant Dashboard](http://${{ secrets.VM_HOST }}:6333/dashboard)" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Check the logs above for details."
          exit 1

